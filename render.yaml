version: 1
services:
  # ---------------------------------------------------------------------------
  # üöÄ Backend API Service (FastAPI)
  # ---------------------------------------------------------------------------
  - type: web
    name: prism-backend-api
    runtime: python
    rootDir: ./prism-backend
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
    startCommand: python -m gunicorn app.main:app -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --workers 1 --timeout 120
    healthCheckPath: /health
    plan: starter
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PYTHONPATH
        value: /opt/render/project/src/prism-backend
      
      # Persistence & Memory
      - key: MONGO_URI
        sync: false
      - key: REDIS_URL
        sync: false
      - key: NEO4J_URI
        sync: false
      - key: NEO4J_USER
        sync: false
      - key: NEO4J_PASSWORD
        sync: false
      - key: PINECONE_API_KEY
        sync: false
      - key: PINECONE_INDEX_NAME
        sync: false

      # AI Services
      - key: GROQ_API_KEY
        sync: false
      - key: GROQ_API_KEYS
        sync: false # Optional: comma-separated for pooling

      # Security
      - key: JWT_SECRET
        generateValue: true
      - key: ENCRYPTION_KEY
        generateValue: true # 32-char key for sensitive data
      - key: CORS_ORIGINS
        sync: false # Set this to your Vercel URL
      
      # Email & Notifications (Celery)
      - key: CELERY_BROKER_URL
        sync: false
      - key: CELERY_RESULT_BACKEND
        sync: false
      - key: SENDGRID_API_KEY
        sync: false
      - key: SENDER_EMAIL
        sync: false

  # ---------------------------------------------------------------------------
  # ‚öôÔ∏è Celery Worker (Background Tasks)
  # ---------------------------------------------------------------------------
  - type: worker
    name: prism-celery-worker
    runtime: python
    rootDir: ./prism-backend
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
    startCommand: python -m celery -A app.core.celery_app worker --loglevel=info --queues=email,default
    plan: starter
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PYTHONPATH
        value: /opt/render/project/src/prism-backend
      
      # Worker needs DB access for task updates
      - key: MONGO_URI
        sync: false
      - key: CELERY_BROKER_URL
        sync: false
      - key: CELERY_RESULT_BACKEND
        sync: false
      - key: SENDGRID_API_KEY
        sync: false
      - key: SENDER_EMAIL
        sync: false

  # ---------------------------------------------------------------------------
  # üïí Celery Beat (Periodic Scheduler)
  # ---------------------------------------------------------------------------
  - type: worker
    name: prism-celery-beat
    runtime: python
    rootDir: ./prism-backend
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
    startCommand: python -m celery -A app.core.celery_app beat --loglevel=info
    plan: starter
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PYTHONPATH
        value: /opt/render/project/src/prism-backend
      - key: MONGO_URI
        sync: false
      - key: CELERY_BROKER_URL
        sync: false
      - key: CELERY_RESULT_BACKEND
        sync: false
      - key: SENDGRID_API_KEY
        sync: false
      - key: SENDER_EMAIL
        sync: false