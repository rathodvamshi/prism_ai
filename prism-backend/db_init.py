"""
Database initialization script for PRISM AI Studio
Creates indexes for optimal performance across all collections
"""

import asyncio\nimport logging\nfrom app.db.mongo_client import db\n\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\nasync def create_indexes():\n    \"\"\"Create all necessary indexes for optimal database performance\"\"\"\n    \n    try:\n        # Users Collection Indexes\n        users_collection = db.users\n        await users_collection.create_index(\"email\", unique=True)\n        await users_collection.create_index(\"user_id\")\n        await users_collection.create_index(\"verified\")\n        await users_collection.create_index(\"isFirstLoginCompleted\")\n        logger.info(\"‚úÖ Created indexes for users collection\")\n        \n        # Chat Sessions Collection Indexes  \n        sessions_collection = db.chat_sessions\n        await sessions_collection.create_index(\"sessionId\", unique=True)\n        await sessions_collection.create_index(\"user_id\")\n        await sessions_collection.create_index([(\"user_id\", 1), (\"updatedAt\", -1)])\n        await sessions_collection.create_index(\"isActive\")\n        await sessions_collection.create_index(\"updatedAt\")\n        logger.info(\"‚úÖ Created indexes for chat_sessions collection\")\n        \n        # User Tasks Collection Indexes\n        tasks_collection = db.user_tasks\n        await tasks_collection.create_index(\"taskId\", unique=True)\n        await tasks_collection.create_index(\"user_id\")\n        await tasks_collection.create_index([(\"user_id\", 1), (\"status\", 1)])\n        await tasks_collection.create_index([(\"user_id\", 1), (\"createdAt\", -1)])\n        await tasks_collection.create_index(\"status\")\n        await tasks_collection.create_index(\"dueDate\")\n        logger.info(\"‚úÖ Created indexes for user_tasks collection\")\n        \n        # User Memory Collection Indexes\n        memory_collection = db.user_memory\n        await memory_collection.create_index(\"id\", unique=True)\n        await memory_collection.create_index(\"user_id\")\n        await memory_collection.create_index([(\"user_id\", 1), (\"importance\", -1), (\"timestamp\", -1)])\n        await memory_collection.create_index(\"type\")\n        await memory_collection.create_index(\"importance\")\n        await memory_collection.create_index(\"timestamp\")\n        logger.info(\"‚úÖ Created indexes for user_memory collection\")\n        \n        # Message Highlights Collection Indexes\n        highlights_collection = db.message_highlights\n        await highlights_collection.create_index(\"highlightId\", unique=True)\n        await highlights_collection.create_index(\"uniqueKey\", unique=True)\n        await highlights_collection.create_index(\"sessionId\")\n        await highlights_collection.create_index(\"messageId\")\n        await highlights_collection.create_index([(\"sessionId\", 1), (\"user_id\", 1)])\n        await highlights_collection.create_index(\"user_id\")\n        logger.info(\"‚úÖ Created indexes for message_highlights collection\")\n        \n        # Mini-Agent Threads Collection Indexes\n        miniagent_collection = db.miniagent_threads\n        await miniagent_collection.create_index(\"threadId\", unique=True)\n        await miniagent_collection.create_index(\"messageId\")\n        await miniagent_collection.create_index(\"sessionId\")\n        await miniagent_collection.create_index(\"user_id\")\n        await miniagent_collection.create_index([(\"user_id\", 1), (\"updatedAt\", -1)])\n        await miniagent_collection.create_index(\"updatedAt\")\n        logger.info(\"‚úÖ Created indexes for miniagent_threads collection\")\n        \n        # Shared Conversations Collection Indexes\n        shares_collection = db.shared_conversations\n        await shares_collection.create_index(\"shareId\", unique=True)\n        await shares_collection.create_index(\"user_id\")\n        await shares_collection.create_index(\"createdAt\")\n        await shares_collection.create_index(\"accessCount\")\n        logger.info(\"‚úÖ Created indexes for shared_conversations collection\")\n        \n        logger.info(\"üéâ All database indexes created successfully!\")\n        \n    except Exception as e:\n        logger.error(f\"‚ùå Error creating indexes: {str(e)}\")\n        raise\n\nasync def verify_indexes():\n    \"\"\"Verify all indexes were created correctly\"\"\"\n    \n    collections = [\n        \"users\",\n        \"chat_sessions\", \n        \"user_tasks\",\n        \"user_memory\",\n        \"message_highlights\",\n        \"miniagent_threads\",\n        \"shared_conversations\"\n    ]\n    \n    for collection_name in collections:\n        collection = db[collection_name]\n        indexes = await collection.list_indexes().to_list(length=None)\n        \n        logger.info(f\"üìä {collection_name} has {len(indexes)} indexes:\")\n        for index in indexes:\n            logger.info(f\"   - {index['name']}: {index.get('key', 'N/A')}\")\n    \n    logger.info(\"‚úÖ Index verification complete\")\n\nasync def main():\n    \"\"\"Main initialization function\"\"\"\n    logger.info(\"üöÄ Starting database initialization...\")\n    \n    await create_indexes()\n    await verify_indexes()\n    \n    logger.info(\"‚ú® Database initialization completed successfully!\")\n\nif __name__ == \"__main__\":\n    asyncio.run(main())